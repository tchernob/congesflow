{% extends "root/base_root.html" %}

{% block title %}Modifier {{ company.name }}{% endblock %}
{% block page_title %}Modifier {{ company.name }}{% endblock %}

{% block content %}
<div style="margin-bottom: var(--space-4);">
    <a href="{{ url_for('root.view_company', company_id=company.id) }}" class="btn btn-secondary btn-sm">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Retour
    </a>
</div>

<form method="post" style="max-width: 600px;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Basic info -->
    <div class="card-static" style="padding: var(--space-5); margin-bottom: var(--space-4);">
        <h2 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-4);">Informations générales</h2>

        <div class="form-group" style="margin-bottom: var(--space-4);">
            <label class="form-label">Nom de l'entreprise</label>
            <input type="text" name="name" class="form-input" value="{{ company.name }}" required>
        </div>

        <div class="form-group" style="margin-bottom: var(--space-4);">
            <label class="form-label" style="display: flex; align-items: center; gap: var(--space-2);">
                <input type="checkbox" name="is_active" {% if company.is_active %}checked{% endif %}>
                Entreprise active
            </label>
            <p style="font-size: var(--text-xs); color: var(--color-ink-muted); margin-top: 4px;">
                Si désactivée, les utilisateurs ne pourront plus se connecter.
            </p>
        </div>

        <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: var(--space-2);">
                <input type="checkbox" name="is_internal" {% if company.is_internal %}checked{% endif %}>
                <span style="color: var(--root-accent); font-weight: 600;">Entreprise interne</span>
            </label>
            <p style="font-size: var(--text-xs); color: var(--color-ink-muted); margin-top: 4px;">
                Les entreprises internes ont accès à toutes les fonctionnalités sans limite et sans facturation (plan Enterprise illimité).
            </p>
        </div>
    </div>

    <!-- Subscription -->
    <div class="card-static" style="padding: var(--space-5); margin-bottom: var(--space-4);">
        <h2 style="font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-4);">Abonnement</h2>

        <div class="form-group" style="margin-bottom: var(--space-4);">
            <label class="form-label">Plan</label>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-3);">
                {% set plan_prices = {'free': 0, 'pro': 39, 'business': 79, 'enterprise': None} %}
                {% for plan_id, plan_name in plans.items() %}
                {% if plan_id in ['free', 'pro', 'business', 'enterprise'] %}
                <label class="plan-option" style="
                    display: flex;
                    flex-direction: column;
                    padding: var(--space-3);
                    border: 2px solid {% if company.plan == plan_id %}var(--root-accent){% else %}var(--color-border){% endif %};
                    border-radius: var(--radius-md);
                    cursor: pointer;
                    transition: all 0.15s;
                ">
                    <input type="radio" name="plan" value="{{ plan_id }}"
                           {% if company.plan == plan_id %}checked{% endif %}
                           style="position: absolute; opacity: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="plan-badge {{ plan_id }}">{{ plan_name }}</span>
                        {% if plan_prices[plan_id] is not none %}
                        <span style="font-weight: 600;">{{ plan_prices[plan_id] }}€/mois</span>
                        {% else %}
                        <span style="font-size: var(--text-xs); color: var(--color-ink-muted);">Sur devis</span>
                        {% endif %}
                    </div>
                    <div style="font-size: var(--text-xs); color: var(--color-ink-muted); margin-top: var(--space-1);">
                        {{ plan_limits.get(plan_id, '?') }} utilisateurs max
                    </div>
                </label>
                {% endif %}
                {% endfor %}
            </div>
            <script>
                document.querySelectorAll('.plan-option').forEach(label => {
                    label.addEventListener('click', function() {
                        document.querySelectorAll('.plan-option').forEach(l => {
                            l.style.borderColor = 'var(--color-border)';
                        });
                        this.style.borderColor = 'var(--root-accent)';
                    });
                });
            </script>
        </div>

        <div class="form-group" style="margin-bottom: var(--space-4);">
            <label class="form-label">Limite d'utilisateurs personnalisée (optionnel)</label>
            <input type="number" name="max_employees_override" class="form-input"
                   value="{{ company.max_employees }}" min="1" max="10000">
            <p style="font-size: var(--text-xs); color: var(--color-ink-muted); margin-top: 4px;">
                Laissez vide pour utiliser la limite par défaut du plan. Actuellement : {{ company.employee_count }} utilisateur(s).
            </p>
        </div>

        <div class="form-group">
            <label class="form-label">Date de fin d'abonnement</label>
            <input type="date" name="subscription_ends_at" class="form-input"
                   value="{{ company.subscription_ends_at.strftime('%Y-%m-%d') if company.subscription_ends_at else '' }}">
            <p style="font-size: var(--text-xs); color: var(--color-ink-muted); margin-top: 4px;">
                Laissez vide si pas de date d'expiration (plan gratuit ou abonnement perpétuel).
            </p>
        </div>
    </div>

    <!-- Current state -->
    <div class="card-static" style="padding: var(--space-5); margin-bottom: var(--space-4); background: var(--color-bg-sunken);">
        <h3 style="font-size: var(--text-sm); font-weight: 600; margin-bottom: var(--space-3);">État actuel</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); font-size: var(--text-sm);">
            <div>
                <span style="color: var(--color-ink-muted);">Plan actuel :</span>
                <span class="plan-badge {{ company.plan }}" style="margin-left: var(--space-2);">{{ company.plan_label }}</span>
            </div>
            <div>
                <span style="color: var(--color-ink-muted);">Utilisateurs :</span>
                <strong>{{ company.employee_count }} / {{ company.max_employees }}</strong>
            </div>
            <div>
                <span style="color: var(--color-ink-muted);">Utilisation :</span>
                <strong>{{ company.usage_percent }}%</strong>
            </div>
            <div>
                <span style="color: var(--color-ink-muted);">Créée le :</span>
                <strong>{{ company.created_at.strftime('%d/%m/%Y') }}</strong>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: var(--space-3);">
        <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
        <a href="{{ url_for('root.view_company', company_id=company.id) }}" class="btn btn-secondary">Annuler</a>
    </div>
</form>
{% endblock %}
