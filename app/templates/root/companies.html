{% extends "root/base_root.html" %}

{% block title %}Entreprises{% endblock %}
{% block page_title %}Entreprises{% endblock %}

{% block content %}
<div class="card-static" style="padding: var(--space-5);">
    <!-- Filters -->
    <form method="get" class="filters-bar">
        <input type="text" name="search" placeholder="Rechercher une entreprise..." value="{{ search }}">
        <select name="plan">
            <option value="">Tous les plans</option>
            {% for plan_id, plan_name in plans.items() %}
            <option value="{{ plan_id }}" {% if plan_filter == plan_id %}selected{% endif %}>{{ plan_name }}</option>
            {% endfor %}
        </select>
        <select name="status">
            <option value="">Tous les statuts</option>
            <option value="active" {% if status == 'active' %}selected{% endif %}>Actives</option>
            <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactives</option>
        </select>
        <button type="submit" class="btn btn-primary">Filtrer</button>
        {% if search or plan_filter or status %}
        <a href="{{ url_for('root.companies') }}" class="btn btn-secondary">Effacer</a>
        {% endif %}
    </form>

    <!-- Results count -->
    <p style="font-size: var(--text-sm); color: var(--color-ink-muted); margin-bottom: var(--space-4);">
        {{ companies|length }} entreprise(s) trouvée(s)
    </p>

    <!-- Table -->
    <table class="root-table">
        <thead>
            <tr>
                <th>
                    <a href="?search={{ search }}&plan={{ plan_filter }}&status={{ status }}&sort=name&order={% if sort == 'name' and order == 'asc' %}desc{% else %}asc{% endif %}" style="color: inherit; text-decoration: none;">
                        Entreprise {% if sort == 'name' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?search={{ search }}&plan={{ plan_filter }}&status={{ status }}&sort=plan&order={% if sort == 'plan' and order == 'asc' %}desc{% else %}asc{% endif %}" style="color: inherit; text-decoration: none;">
                        Plan {% if sort == 'plan' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                    </a>
                </th>
                <th>
                    <a href="?search={{ search }}&plan={{ plan_filter }}&status={{ status }}&sort=users&order={% if sort == 'users' and order == 'asc' %}desc{% else %}asc{% endif %}" style="color: inherit; text-decoration: none;">
                        Utilisateurs {% if sort == 'users' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                    </a>
                </th>
                <th>Utilisation</th>
                <th>Statut</th>
                <th>
                    <a href="?search={{ search }}&plan={{ plan_filter }}&status={{ status }}&sort=created_at&order={% if sort == 'created_at' and order == 'asc' %}desc{% else %}asc{% endif %}" style="color: inherit; text-decoration: none;">
                        Créée le {% if sort == 'created_at' %}{{ '↑' if order == 'asc' else '↓' }}{% endif %}
                    </a>
                </th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for company in companies %}
            <tr>
                <td>
                    <a href="{{ url_for('root.view_company', company_id=company.id) }}" class="company-name" style="color: var(--color-ink); text-decoration: none;">
                        {{ company.name }}
                    </a>
                    {% if company.is_internal %}
                    <span style="background: var(--root-accent); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 500;">INTERNE</span>
                    {% endif %}
                </td>
                <td>
                    <span class="plan-badge {{ company.plan }}">{{ company.plan_label }}</span>
                </td>
                <td>{{ company.employee_count }} / {{ company.max_employees }}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <div style="width: 60px; height: 6px; background: var(--color-border); border-radius: 3px; overflow: hidden;">
                            <div style="width: {{ company.usage_percent }}%; height: 100%; background: {% if company.usage_percent >= 90 %}#EF4444{% elif company.usage_percent >= 70 %}#F59E0B{% else %}var(--color-accent){% endif %};"></div>
                        </div>
                        <span style="font-size: var(--text-xs); color: var(--color-ink-muted);">{{ company.usage_percent }}%</span>
                    </div>
                </td>
                <td>
                    {% if company.is_active %}
                    <span style="color: var(--color-success); font-size: var(--text-xs); font-weight: 500;">Actif</span>
                    {% else %}
                    <span style="color: #EF4444; font-size: var(--text-xs); font-weight: 500;">Inactif</span>
                    {% endif %}
                </td>
                <td class="company-created">{{ company.created_at.strftime('%d/%m/%Y') }}</td>
                <td>
                    <div style="display: flex; gap: var(--space-2);">
                        <a href="{{ url_for('root.view_company', company_id=company.id) }}" class="btn btn-secondary btn-sm">Voir</a>
                        <a href="{{ url_for('root.impersonate', company_id=company.id) }}" class="btn btn-sm" style="background: var(--root-accent); color: white;" title="Se connecter comme admin">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </a>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; color: var(--color-ink-muted); padding: var(--space-6);">
                    Aucune entreprise trouvée
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
