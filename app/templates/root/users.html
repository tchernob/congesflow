{% extends "root/base_root.html" %}

{% block title %}Utilisateurs{% endblock %}
{% block page_title %}Utilisateurs{% endblock %}

{% block content %}
<div class="card-static" style="padding: var(--space-5);">
    <!-- Filters -->
    <form method="get" class="filters-bar">
        <input type="text" name="search" placeholder="Rechercher par nom ou email..." value="{{ search }}">
        <select name="company_id">
            <option value="">Toutes les entreprises</option>
            {% for comp in companies %}
            <option value="{{ comp.id }}" {% if company_id == comp.id|string %}selected{% endif %}>{{ comp.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Rechercher</button>
        {% if search or company_id %}
        <a href="{{ url_for('root.users') }}" class="btn btn-secondary">Effacer</a>
        {% endif %}
    </form>

    <!-- Results count -->
    <p style="font-size: var(--text-sm); color: var(--color-ink-muted); margin-bottom: var(--space-4);">
        {{ users|length }} utilisateur(s) trouvé(s){% if users|length == 100 %} (limité à 100){% endif %}
    </p>

    <!-- Table -->
    <table class="root-table">
        <thead>
            <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>Entreprise</th>
                <th>Rôle</th>
                <th>Statut</th>
                <th>Créé le</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td style="font-weight: 500;">{{ user.full_name }}</td>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.company %}
                    <a href="{{ url_for('root.view_company', company_id=user.company.id) }}" style="color: var(--color-accent); text-decoration: none;">
                        {{ user.company.name }}
                    </a>
                    {% else %}
                    <span style="color: var(--color-ink-muted);">-</span>
                    {% endif %}
                </td>
                <td>
                    <span style="font-size: var(--text-xs); background: var(--color-bg-sunken); padding: 2px 6px; border-radius: 4px;">
                        {{ user.role.description }}
                    </span>
                </td>
                <td>
                    {% if not user.is_active %}
                    <span style="color: #EF4444; font-size: var(--text-xs);">Inactif</span>
                    {% elif user.is_pending_invitation %}
                    <span style="color: #F59E0B; font-size: var(--text-xs);">Invitation en attente</span>
                    {% else %}
                    <span style="color: var(--color-success); font-size: var(--text-xs);">Actif</span>
                    {% endif %}
                </td>
                <td style="color: var(--color-ink-muted); font-size: var(--text-xs);">{{ user.created_at.strftime('%d/%m/%Y') }}</td>
                <td>
                    <form method="post" action="{{ url_for('root.reset_user_password', user_id=user.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-secondary btn-sm" onclick="return confirm('Générer un nouveau lien de réinitialisation pour {{ user.email }} ?')" title="Réinitialiser mot de passe">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; color: var(--color-ink-muted); padding: var(--space-6);">
                    Aucun utilisateur trouvé
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
