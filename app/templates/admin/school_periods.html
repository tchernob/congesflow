{% extends "base.html" %}

{% block title %}Périodes école - TimeOff{% endblock %}
{% block page_title %}Gestion des périodes école{% endblock %}

{% block content %}
<div class="page-header-actions">
    <div class="filters">
        <select class="form-select" id="yearFilter" onchange="applyFilters()">
            {% for y in range(year_filter - 1, year_filter + 2) %}
            <option value="{{ y }}" {% if y == year_filter %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <select class="form-select" id="userFilter" onchange="applyFilters()">
            <option value="">Tous les alternants</option>
            {% for alternant in alternants %}
            <option value="{{ alternant.id }}" {% if user_filter == alternant.id %}selected{% endif %}>
                {{ alternant.full_name }}
            </option>
            {% endfor %}
        </select>
    </div>
    <a href="{{ url_for('admin.new_school_period') }}" class="btn btn-primary">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Ajouter une période
    </a>
</div>

<div class="info-banner mb-6">
    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <p>Gérez les périodes école des alternants. Ces périodes apparaissent dans le calendrier d'équipe et sur Slack.</p>
</div>

{% if alternants %}
    {% if periods %}
    <div class="card-static">
        <div class="table-container" style="border: none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Alternant</th>
                        <th>Dates</th>
                        <th>Durée</th>
                        <th>Description</th>
                        <th>Créé par</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for period in periods %}
                    <tr>
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="user-avatar-sm">{{ period.user.initials }}</div>
                                <span class="font-semibold">{{ period.user.full_name }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="date-range">
                                {{ period.start_date.strftime('%d %b') }} → {{ period.end_date.strftime('%d %b %Y') }}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-purple">
                                {{ period.duration_days }} jour{{ 's' if period.duration_days > 1 else '' }}
                            </span>
                        </td>
                        <td>{{ period.description or 'École' }}</td>
                        <td>
                            {% if period.created_by %}
                                {{ period.created_by.full_name }}
                            {% else %}
                                {{ period.user.full_name }}
                            {% endif %}
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <a href="{{ url_for('admin.edit_school_period', period_id=period.id) }}" class="btn btn-ghost btn-sm">
                                    Modifier
                                </a>
                                <form action="{{ url_for('admin.delete_school_period', period_id=period.id) }}" method="POST" style="display: inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-ghost btn-sm text-danger" onclick="return confirm('Supprimer cette période ?')">
                                        Supprimer
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-static">
        <div class="empty-state">
            <div class="empty-state-icon">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
            </div>
            <h3 class="empty-state-title">Aucune période école</h3>
            <p class="empty-state-text">Aucune période école enregistrée pour {{ year_filter }}{% if user_filter %} pour cet alternant{% endif %}.</p>
            <a href="{{ url_for('admin.new_school_period') }}" class="btn btn-primary">Ajouter une période</a>
        </div>
    </div>
    {% endif %}

    <!-- Résumé par alternant -->
    <div class="mt-8">
        <h3 class="text-lg font-semibold mb-4">Alternants</h3>
        <div class="alternants-grid">
            {% for alternant in alternants %}
            {% set alternant_periods = periods|selectattr('user_id', 'equalto', alternant.id)|list %}
            {% set total_days = alternant_periods|sum(attribute='duration_days') %}
            <div class="alternant-card">
                <div class="alternant-info">
                    <div class="user-avatar-sm">{{ alternant.initials }}</div>
                    <div>
                        <div class="font-semibold">{{ alternant.full_name }}</div>
                        <div class="text-muted text-sm">{{ alternant.team.name if alternant.team else 'Pas d\'équipe' }}</div>
                    </div>
                </div>
                <div class="alternant-stats">
                    <span class="stat-value">{{ total_days }}</span>
                    <span class="stat-label">jours école</span>
                </div>
                <a href="{{ url_for('admin.new_school_period', user_id=alternant.id) }}" class="btn btn-ghost btn-sm">
                    + Ajouter
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
{% else %}
<div class="card-static">
    <div class="empty-state">
        <div class="empty-state-icon">
            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
        </div>
        <h3 class="empty-state-title">Aucun alternant</h3>
        <p class="empty-state-text">Vous n'avez aucun alternant dans votre entreprise. Ajoutez des utilisateurs avec le type de contrat "Alternant" pour gérer leurs périodes école.</p>
        <a href="{{ url_for('admin.users') }}" class="btn btn-primary">Gérer les utilisateurs</a>
    </div>
</div>
{% endif %}

<style>
.page-header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
}

.filters {
    display: flex;
    gap: var(--space-3);
}

.info-banner {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-accent-light);
    border-radius: var(--radius-lg);
    color: var(--color-accent);
    font-size: var(--text-sm);
}

.info-banner svg {
    flex-shrink: 0;
}

.badge-purple {
    background: #8B5CF620;
    color: #8B5CF6;
}

.date-range {
    white-space: nowrap;
}

.alternants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
}

.alternant-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
}

.alternant-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex: 1;
}

.alternant-stats {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 var(--space-4);
    border-left: 1px solid var(--color-border);
}

.stat-value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: #8B5CF6;
}

.stat-label {
    font-size: var(--text-xs);
    color: var(--color-ink-muted);
}

@media (max-width: 640px) {
    .filters {
        width: 100%;
    }
    .filters .form-select {
        flex: 1;
    }
}
</style>

<script>
function applyFilters() {
    const year = document.getElementById('yearFilter').value;
    const userId = document.getElementById('userFilter').value;
    let url = `{{ url_for('admin.school_periods') }}?year=${year}`;
    if (userId) {
        url += `&user_id=${userId}`;
    }
    window.location.href = url;
}
</script>
{% endblock %}
