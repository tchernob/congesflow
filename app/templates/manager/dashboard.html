{% extends "base.html" %}

{% block title %}Dashboard Manager - TimeOff{% endblock %}
{% block page_title %}Mon équipe{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Stats Cards -->
    <section class="stats-grid animate-slide-up">
        <div class="stat-card" style="--stat-color: var(--color-warning);">
            <div class="stat-value">{{ stats.pending_count }}</div>
            <div class="stat-label">Demandes en attente</div>
        </div>
        <div class="stat-card" style="--stat-color: var(--color-primary);">
            <div class="stat-value">{{ stats.absent_today }}</div>
            <div class="stat-label">Absents aujourd'hui</div>
        </div>
        <div class="stat-card" style="--stat-color: var(--color-accent);">
            <div class="stat-value">{{ stats.team_size }}</div>
            <div class="stat-label">Membres d'équipe</div>
        </div>
        <div class="stat-card" style="--stat-color: var(--color-info);">
            <div class="stat-value">{{ stats.upcoming_count }}</div>
            <div class="stat-label">Absences à venir (7j)</div>
        </div>
    </section>

    <div class="content-grid-manager">
        <!-- Pending Requests -->
        <section class="card-static animate-slide-up stagger-1">
            <div class="card-header">
                <h3 class="card-title">Demandes en attente</h3>
                <a href="{{ url_for('manager.requests') }}" class="btn btn-ghost btn-sm">Voir tout</a>
            </div>
            <div class="card-body p-0">
                {% if pending_requests %}
                <div class="pending-list">
                    {% for req in pending_requests[:5] %}
                    <div class="pending-item">
                        <div class="pending-avatar">{{ req.employee.initials }}</div>
                        <div class="pending-info">
                            <div class="pending-name">{{ req.employee.full_name }}</div>
                            <div class="pending-details">
                                <span class="pending-type" style="color: {{ req.leave_type.color }};">{{ req.leave_type.name }}</span>
                                <span class="pending-dates">{{ req.start_date.strftime('%d/%m') }} - {{ req.end_date.strftime('%d/%m') }}</span>
                                <span class="pending-days">{{ req.days_count }}j</span>
                            </div>
                        </div>
                        <div class="pending-actions">
                            <form action="{{ url_for('manager.approve_request', request_id=req.id) }}" method="POST" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-accent btn-sm">Approuver</button>
                            </form>
                            <a href="{{ url_for('manager.view_request', request_id=req.id) }}" class="btn btn-ghost btn-sm">Détails</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state p-8">
                    <div class="empty-state-icon">
                        <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <p class="empty-state-text">Aucune demande en attente</p>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Current Absences -->
        <section class="card-static animate-slide-up stagger-2">
            <div class="card-header">
                <h3 class="card-title">Absences en cours</h3>
            </div>
            <div class="card-body">
                {% if current_absences %}
                <div class="absence-list">
                    {% for absence in current_absences %}
                    <div class="absence-item">
                        <div class="absence-avatar" style="background: {{ absence.leave_type.color }};">
                            {{ absence.employee.initials }}
                        </div>
                        <div class="absence-info">
                            <div class="absence-name">{{ absence.employee.full_name }}</div>
                            <div class="absence-meta">
                                {{ absence.leave_type.name }} • Retour le {{ absence.end_date.strftime('%d/%m') }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p class="text-muted text-sm">Toute l'équipe est présente</p>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Upcoming Absences -->
        <section class="card-static animate-slide-up stagger-3">
            <div class="card-header">
                <h3 class="card-title">Absences à venir</h3>
                <a href="{{ url_for('manager.calendar') }}" class="btn btn-ghost btn-sm">Calendrier</a>
            </div>
            <div class="card-body">
                {% if upcoming_absences %}
                <div class="upcoming-team-list">
                    {% for absence in upcoming_absences %}
                    <div class="upcoming-team-item">
                        <div class="upcoming-date-badge">
                            <span class="date-day">{{ absence.start_date.strftime('%d') }}</span>
                            <span class="date-month">{{ absence.start_date.strftime('%b') }}</span>
                        </div>
                        <div class="upcoming-team-info">
                            <div class="upcoming-team-name">{{ absence.employee.full_name }}</div>
                            <div class="upcoming-team-meta">
                                {{ absence.leave_type.name }} • {{ absence.days_count }} jour{{ 's' if absence.days_count > 1 else '' }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p class="text-muted text-sm">Aucune absence prévue cette semaine</p>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Team Overview -->
        <section class="card-static animate-slide-up stagger-4">
            <div class="card-header">
                <h3 class="card-title">Mon équipe</h3>
                <a href="{{ url_for('manager.team') }}" class="btn btn-ghost btn-sm">Voir tout</a>
            </div>
            <div class="card-body">
                {% if team_members %}
                <div class="team-mini-grid">
                    {% for member in team_members[:8] %}
                    <a href="{{ url_for('manager.team_member', user_id=member.id) }}" class="team-mini-card">
                        <div class="team-mini-avatar">{{ member.initials }}</div>
                        <div class="team-mini-name">{{ member.first_name }}</div>
                    </a>
                    {% endfor %}
                    {% if team_members|length > 8 %}
                    <a href="{{ url_for('manager.team') }}" class="team-mini-card team-mini-more">
                        <div class="team-mini-count">+{{ team_members|length - 8 }}</div>
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p class="text-muted text-sm">Aucun membre dans votre équipe</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>
</div>

<style>
.dashboard-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
}

.content-grid-manager {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
}

/* Pending List */
.pending-list {
    display: flex;
    flex-direction: column;
}

.pending-item {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4) var(--space-5);
    border-bottom: var(--border-thin);
}

.pending-item:last-child {
    border-bottom: none;
}

.pending-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: var(--color-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-sm);
    flex-shrink: 0;
}

.pending-info {
    flex: 1;
    min-width: 0;
}

.pending-name {
    font-weight: 600;
    margin-bottom: var(--space-1);
}

.pending-details {
    display: flex;
    gap: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-ink-muted);
}

.pending-type {
    font-weight: 500;
}

.pending-actions {
    display: flex;
    gap: var(--space-2);
    flex-shrink: 0;
}

/* Absence List */
.absence-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.absence-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg);
    border: var(--border-thin);
}

.absence-avatar {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-xs);
}

.absence-name {
    font-weight: 600;
    font-size: var(--text-sm);
}

.absence-meta {
    font-size: var(--text-xs);
    color: var(--color-ink-muted);
}

/* Upcoming Team List */
.upcoming-team-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.upcoming-team-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.upcoming-date-badge {
    width: 48px;
    padding: var(--space-2);
    background: var(--color-bg-sunken);
    border: var(--border-thin);
    text-align: center;
}

.date-day {
    display: block;
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-style: italic;
    line-height: 1;
}

.date-month {
    display: block;
    font-size: var(--text-xs);
    text-transform: uppercase;
    color: var(--color-ink-muted);
}

.upcoming-team-name {
    font-weight: 600;
    font-size: var(--text-sm);
}

.upcoming-team-meta {
    font-size: var(--text-xs);
    color: var(--color-ink-muted);
}

/* Team Mini Grid */
.team-mini-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-3);
}

.team-mini-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3);
    background: var(--color-bg);
    border: var(--border-thin);
    text-decoration: none;
    color: var(--color-ink);
    transition: var(--transition-fast);
}

.team-mini-card:hover {
    background: var(--color-bg-sunken);
    transform: translateY(-2px);
}

.team-mini-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: var(--color-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-sm);
}

.team-mini-name {
    font-size: var(--text-xs);
    font-weight: 500;
    text-align: center;
}

.team-mini-more {
    justify-content: center;
}

.team-mini-count {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-style: italic;
    color: var(--color-ink-muted);
}

@media (max-width: 1200px) {
    .content-grid-manager {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .pending-item {
        flex-wrap: wrap;
    }

    .pending-actions {
        width: 100%;
        margin-top: var(--space-2);
    }

    .team-mini-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}
</style>
{% endblock %}
